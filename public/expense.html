<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Daily Expense App</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .premium-btn {
      background: gold;
      color: black;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .premium-badge {
      background: gold;
      color: black;
      padding: 5px 15px;
      border-radius: 15px;
      font-weight: bold;
    }

    .ai-badge {
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      margin-left: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }

    form input,
    form select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    form input:focus,
    form select:focus {
      outline: none;
      border-color: #667eea;
    }

    button[type="submit"] {
      width: 100%;
      padding: 14px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    button[type="submit"]:hover {
      background: #45a049;
    }

    ul {
      margin-top: 20px;
      padding: 0;
    }

    li {
      list-style: none;
      margin-bottom: 10px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }

    #leaderboardBtn {
      margin-top: 20px;
      display: none;
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #leaderboardBtn:hover {
      background: #5568d3;
    }

    #leaderboardTitle {
      margin-top: 30px;
      display: none;
      color: #333;
    }

    .delete-btn {
      float: right;
      background: #f44336;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background: #da190b;
    }

    #pagination {
      margin-top: 20px;
      text-align: center;
    }

    #pagination button {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
    }

    #pagination button:hover {
      background: #5568d3;
    }

    #pagination button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #pageInfo {
      display: inline-block;
      margin: 0 15px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="header">
      <h2>Daily Expense App</h2>
      <div id="premiumSection"></div>
    </div>

    <form onsubmit="addExpense(event)">
      <div class="form-group">
        <label for="amount">Enter Expense Amount (₹)</label>
        <input 
          type="number" 
          id="amount" 
          placeholder="Enter expense amount" 
          required 
          step="0.01"
        >
      </div>

      <div class="form-group">
        <label for="description">Enter Description</label>
        <input 
          type="text" 
          id="description" 
          placeholder="Enter description" 
          required
          oninput="suggestCategoryRealtime()"
        >
      </div>

      <div class="form-group">
        <label for="category">Select Category</label>
        <select id="category">
          <option value="auto">Auto-Categorize with AI</option>
          <option value="Food">Food</option>
          <option value="Fuel">Fuel</option>
          <option value="Shopping">Shopping</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Travel">Travel</option>
          <option value="Bills">Bills</option>
          <option value="Healthcare">Healthcare</option>
          <option value="Education">Education</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <button type="submit">Add Expense</button>
    </form>

    <h3>Expenses</h3>
    <ul id="expenseList"></ul>
    <div id="pagination">
      <button onclick="changePage(-1)" id="prevBtn">⬅ Prev</button>
      <span id="pageInfo"></span>
      <button onclick="changePage(1)" id="nextBtn">Next ➡</button>
    </div>
    <button id="leaderboardBtn" onclick="loadLeaderboard()">
      Show Leaderboard
    </button>

    <h3 id="leaderboardTitle">Leaderboard</h3>
    <ul id="leaderboard"></ul>
  </div>

  <script>
    const API_URL = "http://localhost:3000";
    let cashfree;
    let isPremiumUser = false;
    let aiSuggestedCategory = null;
    let categoryTimeout;
    let currentPage = 1;
    const limit = 10;
    let totalPages = 1;
    const token = localStorage.getItem("token");
    
    if (!token) {
      alert("Please login first");
      window.location.href = "login.html";
    }

    function getAuthHeaders() {
      return { Authorization: token };
    }

    async function initCashfree() {
      cashfree = await Cashfree({ mode: "sandbox" });
    }
    initCashfree();

    function updatePremiumUI() {
      const premiumSection = document.getElementById("premiumSection");
      const leaderboardBtn = document.getElementById("leaderboardBtn");

      if (isPremiumUser) {
        premiumSection.innerHTML =
          '<span class="premium-badge">⭐ Premium User</span>';
        leaderboardBtn.style.display = "inline-block";
      } else {
        premiumSection.innerHTML =
          '<button class="premium-btn" onclick="buyPremium()">Buy Premium</button>';
        leaderboardBtn.style.display = "none";
      }
    }

    function suggestCategoryRealtime() {
      clearTimeout(categoryTimeout);
      
      categoryTimeout = setTimeout(() => {
        suggestCategory();
      }, 1500); 
    }

    async function suggestCategory() {
      const description = document.getElementById('description').value;
      const categorySelect = document.getElementById('category');

      if (categorySelect.value === 'auto' && description.trim().length > 3) {
        try {
          const res = await axios.post(
            `${API_URL}/expense/categorize`,
            { description },
            { headers: getAuthHeaders() }
          );

          aiSuggestedCategory = res.data.category;
          
          categorySelect.value = aiSuggestedCategory;

        } catch (err) {
          console.error('AI categorization error:', err);
        }
      }
    }

    async function buyPremium() {
      try {
        const res = await axios.post(
          `${API_URL}/premium/purchasepremium`,
          {},
          { headers: getAuthHeaders() }
        );

        const { orderId, sessionId } = res.data;

        cashfree.checkout({
          paymentSessionId: sessionId,
          redirectTarget: "_modal"
        }).then(async (result) => {
          if (result.error) {
            await updateTransaction(orderId, "FAILED");
            alert("Payment Failed");
          }

          if (result.paymentDetails) {
            await updateTransaction(orderId, "SUCCESS");
          }
        });

      } catch (err) {
        alert("Failed to initiate payment");
      }
    }

    async function updateTransaction(orderId, status) {
      try {
        await axios.post(
          `${API_URL}/premium/updatetransaction`,
          { orderId, status },
          { headers: getAuthHeaders() }
        );

        if (status === "SUCCESS") {
          alert("You are now a Premium User");
          isPremiumUser = true;
          updatePremiumUI();
        }

      } catch (err) {
        console.error(err);
      }
    }

    async function addExpense(e) {
      e.preventDefault();

      let selectedCategory = category.value;

      if (selectedCategory === 'auto' && aiSuggestedCategory) {
        selectedCategory = aiSuggestedCategory;
      }

      if (selectedCategory === 'auto') {
        selectedCategory = 'Food';
      }

      const expense = {
        amount: amount.value,
        description: description.value,
        category: selectedCategory
      };

      try {
        const res = await axios.post(
          `${API_URL}/expense/add`,
          expense,
          { headers: getAuthHeaders() }
        );

        e.target.reset();
        aiSuggestedCategory = null;
        
        document.getElementById('category').value = 'auto';

        await loadExpenses(currentPage);

        if (isPremiumUser) {
          loadLeaderboard();
        }

      } catch (err) {
        console.error(err);
        alert("Error adding expense");
      }
    }

    function showExpense(expense) {
      const li = document.createElement("li");
      li.id = expense.id;
      li.innerHTML = `
        <strong>₹${expense.amount}</strong> - ${expense.description} 
        <span style="color: #667eea; font-weight: bold;">[${expense.category}]</span>
        <button onclick="deleteExpense(${expense.id})" class="delete-btn">Delete</button>
      `;
      expenseList.appendChild(li);
    }

    async function deleteExpense(id) {
      try {
        await axios.delete(
          `${API_URL}/expense/delete/${id}`,
          { headers: getAuthHeaders() }
        );

        await loadExpenses(currentPage);

        if (isPremiumUser) {
          loadLeaderboard();
        }
      } catch {
        alert("Error deleting expense");
      }
    }

    async function loadLeaderboard() {
      try {
        leaderboardTitle.style.display = "block";
        leaderboard.innerHTML = "";

        const res = await axios.get(
          `${API_URL}/premium/showleaderboard`,
          { headers: getAuthHeaders() }
        );

        if (!res.data || res.data.length === 0) {
          leaderboard.innerHTML = "<li>No leaderboard data</li>";
          return;
        }

        res.data.forEach(item => {
          const name = item.name || "Unknown User";
          const total = item.totalExpense || 0;

          const li = document.createElement("li");
          li.textContent = `• Name: ${name}, Total Expense: ₹${total}`;
          leaderboard.appendChild(li);
        });

      } catch (err) {
        console.error("Leaderboard error:", err);
        alert("Failed to load leaderboard");
      }
    }

    async function loadExpenses(page = 1) {
      try {
        expenseList.innerHTML = "";

        const res = await axios.get(
          `${API_URL}/expense/get?page=${page}&limit=${limit}`,
          { headers: getAuthHeaders() }
        );

        currentPage = res.data.currentPage;
        totalPages = res.data.totalPages;

        res.data.expenses.forEach(showExpense);

        pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;

        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;

      } catch (err) {
        console.error("Error loading expenses:", err);
        alert("Failed to load expenses");
      }
    }

    function changePage(dir) {
      const next = currentPage + dir;
      if (next < 1 || next > totalPages) return;
      loadExpenses(next);
    }

    window.onload = async () => {
      try {
        const statusRes = await axios.get(
          `${API_URL}/premium/status`,
          { headers: getAuthHeaders() }
        );

        isPremiumUser = statusRes.data.isPremium;
        updatePremiumUI();

        await loadExpenses(1);

      } catch (err) {
        console.error(err);
      }
    };
  </script>

</body>

</html>